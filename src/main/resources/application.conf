connection-manager {
  # Уникальный ID инстанса для Static Partition Assignment в Kafka
  # teltonika → cm-instance-1, wialon → cm-instance-2, ruptela → cm-instance-3, navtelecom → cm-instance-4
  instance-id = "cm-instance-1"
  instance-id = ${?INSTANCE_ID}
  
  tcp {
    teltonika { port = 5001, enabled = true }
    wialon { port = 5002, enabled = true }
    ruptela { port = 5003, enabled = true }
    navtelecom { port = 5004, enabled = true }
    
    boss-threads = 1
    worker-threads = 4
    max-connections = 5000
    keep-alive = true
    tcp-nodelay = true
    connection-timeout-seconds = 30
    read-timeout-seconds = 60
    write-timeout-seconds = 30
    
    # Idle timeout - отключение неактивных соединений
    # Можно переопределить через Redis динамически
    idle-timeout-seconds = 300          # 5 минут без данных = disconnect
    idle-timeout-seconds = ${?TCP_IDLE_TIMEOUT}
    idle-check-interval-seconds = 60    # Проверка каждую минуту
  }
  
  http {
    port = 8080
    host = "0.0.0.0"
  }
  
  redis {
    host = "localhost"
    host = ${?REDIS_HOST}
    port = 6379
    port = ${?REDIS_PORT}
    password = null
    password = ${?REDIS_PASSWORD}
    database = 0
    pool-size = 10
    vehicle-ttl-seconds = 3600
    position-ttl-seconds = 3600
  }
  
  kafka {
    bootstrap-servers = "localhost:9092"
    bootstrap-servers = ${?KAFKA_BOOTSTRAP_SERVERS}
    producer {
      acks = "1"
      retries = 3
      batch-size = 16384
      linger-ms = 10
      compression-type = "none"
    }
    consumer {
      group-id = "connection-manager"
      session-timeout-ms = 30000
      auto-offset-reset = "latest"
      max-poll-records = 100
    }
    topics {
      gps-events = "gps-events"
      gps-events-rules = "gps-events-rules"
      gps-events-retranslation = "gps-events-retranslation"
      device-status = "device-status"
      device-commands = "device-commands"
      device-events = "device-events"
      command-audit = "command-audit"
      unknown-devices = "unknown-devices"
      unknown-gps-events = "unknown-gps-events"
    }
  }
  
  filters {
    dead-reckoning {
      max-speed-kmh = 300
      max-jump-meters = 1000
      max-jump-seconds = 1
    }
    stationary {
      min-distance-meters = 20
      min-speed-kmh = 2
    }
  }
  
  # Обработка команд (через Kafka device-commands)
  commands {
    timeout-seconds = 30
    max-retries = 3
    max-pending-per-device = 100
    pending-commands-ttl-hours = 24
  }

  # ============================================================
  # DEPRECATED: Redis Pub/Sub для команд (заменено на Kafka)
  # ============================================================
  # commands {
  #   enabled = true
  #   timeout-seconds = 30
  #   max-retries = 3
  #   redis-channel-pattern = "commands:*"
  #   results-channel-prefix = "command-results:"
  # }
  
  logging {
    level = "INFO"
    level = ${?LOG_LEVEL}
    log-gps-points = false
  }
}
